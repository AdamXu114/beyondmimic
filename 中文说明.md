# BeyondMimic 运动追踪代码

[[IsaacSim](https://img.shields.io/badge/IsaacSim-4.5.0-silver.svg)](https://docs.omniverse.nvidia.com/isaacsim/latest/overview.html)
[[Isaac Lab](https://img.shields.io/badge/IsaacLab-2.1.0-silver)](https://isaac-sim.github.io/IsaacLab)
[[Python](https://img.shields.io/badge/python-3.10-blue.svg)](https://docs.python.org/3/whatsnew/3.10.html)
[[Linux platform](https://img.shields.io/badge/platform-linux--64-orange.svg)](https://releases.ubuntu.com/20.04/)
[[pre-commit](https://img.shields.io/badge/pre--commit-enabled-brightgreen?logo=pre-commit&logoColor=white)](https://pre-commit.com/)
[[License](https://img.shields.io/badge/license-MIT-yellow.svg)](https://opensource.org/license/mit)

[[官网]](https://beyondmimic.github.io/)
[[论文]](https://arxiv.org/abs/2508.08241)
[[视频]](https://youtu.be/RS_MtKVIAzY)

## 概述

BeyondMimic 是一个多功能的人形机器人控制框架，能够在真实世界部署中提供具有最先进运动质量的高动态运动追踪，并通过基于引导扩散的控制器实现可操控的运行时控制。

本代码库涵盖了 BeyondMimic 中的运动追踪训练部分。**在加入自适应采样后，你应该能够在 LAFAN1 数据集中训练任何适用于仿真到现实迁移的运动，而无需调整任何参数**。

待办事项列表：

- [ ] 自适应采样：修复数值问题带来的一些 bug。
- [ ] 部署：将在另一个代码库中进行。

## 安装

- 按照 [安装指南](https://isaac-sim.github.io/IsaacLab/main/source/setup/installation/index.html) 安装 Isaac Lab v2.1.0。我们建议使用 conda 安装，因为它可以简化从终端调用 Python 脚本的过程。

- 将此代码库克隆到与 Isaac Lab 安装目录分开的位置（即在 `IsaacLab` 目录之外）：

```bash
# 选项 1: SSH
git clone git@github.com:HybridRobotics/whole_body_tracking.git

# 选项 2: HTTPS
git clone https://github.com/HybridRobotics/whole_body_tracking.git
```

- 从 GCS 拉取机器人描述文件

```bash
# 进入代码库
cd whole_body_tracking
# 将所有文件/目录中出现的 whole_body_tracking 重命名为 your_fancy_extension_name
curl -L -o unitree_description.tar.gz https://storage.googleapis.com/qiayuanl_robot_descriptions/unitree_description.tar.gz && \
tar -xzf unitree_description.tar.gz -C source/whole_body_tracking/whole_body_tracking/assets/ && \
rm unitree_description.tar.gz
```

- 使用已安装 Isaac Lab 的 Python 解释器安装库

```bash
python -m pip install -e source/whole_body_tracking
```

## 运动追踪

### 运动预处理与注册表设置

为了管理本工作中使用的大量运动数据，我们利用 WandB 注册表来自动存储和加载参考运动。
注意：参考运动应已完成重定向，并且仅使用广义坐标。

- 收集参考运动数据集（请遵守原始许可证），我们使用与 Unitree 数据集相同的 .csv 格式约定

    - 重定向后的 LAFAN1 数据集可在 [HuggingFace](https://huggingface.co/datasets/lvhaidong/LAFAN1_Retargeting_Dataset) 获取
    - 侧踢动作来自 [KungfuBot](https://kungfu-bot.github.io/)
    - 克里斯蒂亚诺·罗纳尔多的庆祝动作来自 [ASAP](https://github.com/LeCAR-Lab/ASAP)。
    - 平衡动作来自 [HuB](https://hub-robot.github.io/)

- 登录你的 WandB 账户；在左侧的 Core 下访问注册表。创建一个名为 "Motions" 的新注册表集合，工件类型为 "All Types"。

- 通过前向运动学将重定向后的运动转换为包含最大坐标信息（身体姿态、身体速度和身体加速度）的格式，

```bash
python scripts/csv_to_npz.py --input_file {motion_name}.csv --input_fps 30 --output_name {motion_name} --headless
```

这将自动将处理后的运动文件上传到 WandB 注册表，输出名称为 {motion_name}。

- 通过在 Isaac Sim 中回放运动来测试 WandB 注册表是否正常工作：

```bash
python scripts/replay_npz.py --registry_name={your-organization}-org/wandb-registry-motions/{motion_name}
```

- 调试
    - 确保将 WANDB_ENTITY 导出为你的组织名称，而不是个人用户名。
    - 如果 /tmp 文件夹不可访问，请修改 csv_to_npz.py 的第 319 行和第 326 行，指向你选择的临时文件夹。

### 策略训练

- 使用以下命令训练策略：

```bash
python scripts/rsl_rl/train.py --task=Tracking-Flat-G1-v0 \
--registry_name {your-organization}-org/wandb-registry-motions/{motion_name} \
--headless --logger wandb --log_project_name {project_name} --run_name {run_name}
```

### 策略评估

- 使用以下命令播放训练好的策略：

```bash
python scripts/rsl_rl/play.py --task=Tracking-Flat-G1-v0 --num_envs=2 --wandb_path={wandb-run-path}
```

WandB 运行路径可以在运行概览中找到。其格式为 {your_organization}/{project_name}/ 加上一个唯一的 8 位字符标识符。请注意，run_name 与 run_path 不同。

## 代码结构

以下是本代码库的代码结构概览：

- **`source/whole_body_tracking/whole_body_tracking/tasks/tracking/mdp`**
  此目录包含用于定义 BeyondMimic MDP 的原子函数。以下是函数的细分：

    - **`commands.py`**
      命令库，用于从参考运动、当前机器人状态和误差计算中计算相关变量。包括姿态和速度误差计算、初始状态随机化以及自适应采样。

    - **`rewards.py`**
      实现 DeepMimic 奖励函数和平滑项。

    - **`events.py`**
      实现域随机化项。

    - **`observations.py`**
      实现运动追踪和数据收集的观测项。

    - **`terminations.py`**
      实现早期终止和超时。

- **`source/whole_body_tracking/whole_body_tracking/tasks/tracking/tracking_env_cfg.py`**
  包含跟踪任务的环境（MDP）超参数配置。

- **`source/whole_body_tracking/whole_body_tracking/tasks/tracking/config/g1/agents/rsl_rl_ppo_cfg.py`**
  包含跟踪任务的 PPO 超参数。

- **`source/whole_body_tracking/whole_body_tracking/robots`**
  包含机器人特定设置，包括阻尼参数、关节刚度/阻尼计算以及动作尺度计算。

- **`scripts`**
  包含用于预处理运动数据、训练策略和评估训练策略的实用脚本。

此结构旨在确保模块化，并为扩展项目的开发人员提供便捷的导航体验。